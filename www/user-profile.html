<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="msapplication-tap-highlight" content="no" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
        <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline'; style-src 'self' 'unsafe-inline'; media-src *" />
        <link rel="stylesheet" href="css/bootstrap.min.css">
            <link rel="stylesheet" type="text/css" href="css/font-awesome.min.css" />
            <link rel="stylesheet" type="text/css" href="css/bootstrap-left-slide-menu.css" />
            <link rel="stylesheet" type="text/css" href="css/index.css" />
            <link rel="stylesheet" type="text/css" href="css/header.css" />
            <script type="text/javascript" src="js/jquery.min.js"></script>
            <script type="text/javascript" src="js/bootstrap.min.js"></script>
            <script type="text/javascript" src="js/bootstrap-left-slide-menu.js"></script>
            <script type="text/javascript" src="js/header.js"></script>
            <script type="text/javascript" src="js/bootstrap-multiselect.js"></script>
            <link rel="stylesheet" href="css/bootstrap-multiselect.css" type="text/css"/>
        </head>
        <style type="text/css">

          #loader{
            position: absolute;
            width: 100px; /*the image width*/
            height: 100px; /*the image height*/
            left: 50%;
            top: 50%;
            margin-left: -50px; /*half the image width*/
            margin-top: -50px; /*half the image height*/
        }
        </style>
        <body>
        <img src="img/loader.gif" id="loader" style="display: none;">
            <div id="listing_screen" style=" background-color: rgb(239, 239, 239)">
                <!--header-->
                <!--header-->
                <div class="header-login">
                  <div class="col-xs-2 col-md-3">
                    <div id="wrapper">
                      <div class="overlay" style="display: none;"></div>
                      <nav class="navbar navbar-inverse navbar-fixed-top" id="sidebar-wrapper" role="navigation">
                        <ul class="nav sidebar-nav">
                          <li>
                            <a href="user-profile.html">
                              <i class="fa fa-user" aria-hidden="true"></i> Profile
                            </a>
                          </li>
                          <li>
                            <a href="listing.html">
                              <i class="fa fa-list" aria-hidden="true"></i> Dealer list
                            </a>
                          </li>
                          <li>
                            <a href="notification.html">
                              <i class="fa fa-bell-o" aria-hidden="true"></i> Notifications
                            </a>
                          </li>
                          <li>
                            <a href="javascript:void(0);" class="logout">
                              <i class="fa fa-sign-out" aria-hidden="true"></i> Logout
                            </a>
                          </li>
                        </ul>
                      </nav>
                      <div id="page-content-wrapper">
                        <button type="button" class="hamburger animated fadeInLeft is-closed" data-toggle="offcanvas">
                          <span class="hamb-top"></span>
                          <span class="hamb-middle"></span>
                          <span class="hamb-bottom"></span>
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="col-xs-8 col-md-6 text-center">User Profile</div>
                  <div class="col-xs-2 col-md-3 text-right notify">
                    <a href="notification.html">

                      <i class="fa fa-bell-o" aria-hidden="true">
                        <span class="num bell">0</span>
                      </i>
                    </a>
                  </div>
                </div>
                <!--//header-->
                <!--main-->
                <div class="container" style="margin-top: 70px; margin-bottom: 100px;">
                     <!--  <form action="/action_page.php" style="margin-top: 30px; margin-bottom: 52px;"> -->
                    <div class="form-group">
                      <label for="email" class="font-label">Preferred Territory:</label>
                      <select id="territory" class="form-group" multiple="multiple">
                          <!-- <option value="cheese">Cheese</option>
                          <option value="tomatoes">Tomatoes</option>
                          <option value="mozarella">Mozzarella</option>
                          <option value="mushrooms">Mushrooms</option>
                          <option value="pepperoni">Pepperoni</option>
                          <option value="onions">Onions</option> -->
                      </select>
                    </div>
                    <div class="form-group">
                      <label for="name" class="font-label">Name:</label>
                      <input type="text" class="form-control" id="name" name="pwd" required>
                    </div>
                    <div class="form-group">
                      <label for="bussinessname" class="font-label">Bussiness Name:</label>
                      <input type="text" class="form-control" id="bname" name="pwd" required>
                    </div>
                    <div class="form-group">
                      <label for="address" class="font-label">Address:</label>
                      <textarea class="form-control" rows="5" id="address" required></textarea>
                    </div>
                    <div class="form-group">
                      <label for="phonenumber" class="font-label">Phone Number:</label>
                      <input type="tel" class="form-control" id="phone" required
           pattern="[0-9]{3}-[0-9]{3}-[0-9]{4}" onblur="formatPhone(this);"  name="pwd">
                    </div>
                    <div class="form-group">
                      <label for="email" class="font-label">Email:</label>
                      <input type="email" class="form-control" id="email" name="pwd" required>
                    </div>

                    <button type="submit" class="btn btn-default btn-lg btn-block update-user">Update</button>
                  <!-- </form> -->
                </div>
                    <!--//main-->
                    <div class="footer-login" style="height: 72px;">
                        <div class="contact-icon">
                          <div class="col-xs-4 col-md-4 text-center">
                            <a href="user-profile.html" >
                              <i class="fa fa-user-circle" aria-hidden="true" style="font-size:38px"></i>
                            </a>
                          </div>
                          <div class="col-xs-4 col-md-4 text-center">
                            <a href="listing.html" >
                              <i class="fa fa-handshake-o" aria-hidden="true" style="font-size:38px"></i>
                            </a>
                          </div>
                          <div class="col-xs-4 col-md-4 text-center">
                            <a href="javascript:void(0)" >
                              <i class="fa fa-building-o" aria-hidden="true" style="font-size:38px"></i>
                            </a>
                          </div>
                      </div>
                    </div>
                </div>
            </body>
            <script type="text/javascript">
            $(document).ready(function(){

                if (typeof(Storage) !== "undefined") {
                    // Store
                    var userId = localStorage.getItem("cookies_user_id");
                    getUserProfile(userId);
                }else{
                    alert("Something goes wrong!!!");
                }


            });

            function formatPhone(obj) {
                var numbers = obj.value.replace(/\D/g, ''),
                char = { 3: '-', 6: '-' };
                obj.value = '';
                for (var i = 0; i < numbers.length; i++) {
                    obj.value += (char[i] || '') + numbers[i];
                }
            }



                function getUserProfile(userid){
                    //alert(userid);
                      $.ajax({
                        url:'https://elite-dealers.com/api/userprofile.php',
                        data:{user_id:userid},
                        dataType:'json',
                        type:"post",
                        beforeSend: function(){
                            $('#loader').show();
                            $('#listing_screen').hide();
                        },
                        success:function(xhr){
                           //console.log("all user success");
                            var parsed_data;
                            if (typeof xhr == 'object'){
                                parsed_data = xhr;
                            }
                            else {
                                parsed_data = $.parseJSON(xhr);
                            }
                            console.log(xhr.messages);
                            var dynamichtml = '<ul class="list">';
                            var i=0;
                            $.each(xhr.messages, function(key, val){
                               // console.log(val);
                               $("#name").val(val.username);
                               $("#email").val(val.email);
                               $("#bname").val(val.b_name);
                               $("#address").val(val.address);
                               $("#phone").val(val.phone);


                            });

                            console.log(xhr.territory);

                            var htmlOption="";

                            $.each(xhr.territory, function(key, val){

                                var isAvailable = checkTerritory(xhr.messages[0].territory, val.id);
                                var htmlContent = "";
                                if(isAvailable){
                                    htmlContent = "<option value='"+ val.id+"' selected>"+val.name+"</option>";
                                }else{
                                  htmlContent = "<option value='"+ val.id+"'>"+val.name+"</option>";
                                }

                                htmlOption = htmlOption + htmlContent;
                            });

                            $("#territory").html(htmlOption);
                            $('#territory').multiselect();

                            $('#loader').hide();
                            $('#listing_screen').show();
                            $('#dealer-list').html(dynamichtml);
                        },
                        error:function(data){
                            $('#loader').hide();
                            $('#listing_screen').show();
                       //     alert("Server Error.");
                        }
                  });
                }

                function checkTerritory(territory, selectId){
                    var flag=false;
                    $.each(territory, function(key, val){
                        if(val.id==selectId){
                          flag = true;
                        }
                    });

                    return flag;
                }

                $(".update-user").click(function(){
                    var name = $("#name").val();
                    var bname = $("#bname").val();
                    var address = $("#address").val();
                    var email = $("#email").val();
                    var phone = $("#phone").val();
                    var user_id = localStorage.getItem("cookies_user_id");

                    var territoryList = [];
                    var terName = [];
                    $.each($("#territory option:selected"), function(){
                        territoryList.push($(this).val());
                        terName.push($(this).text());
                    });

                    var tName = terName.join(",");

                    if(validate(name, bname, address, email, phone, territoryList)) {

                        $.ajax({
                        url:'https://elite-dealers.com/api/updateuser.php',
                        data:{user_id:user_id, name:name, bname:bname, address:address, email:email, phone:phone, territories:tName},
                        dataType:'json',
                        type:"post",
                        beforeSend: function(){
                            $('#loader').show();
                            $('#listing_screen').hide();
                        },
                        success:function(xhr){
                           //console.log("all user success");
                            var parsed_data;
                            if (typeof xhr == 'object'){
                                parsed_data = xhr;
                            }
                            else {
                                parsed_data = $.parseJSON(xhr);
                            }
                            console.log(xhr.messages);

                            $('#loader').hide();
                            $('#listing_screen').show();

                            alert("Updated successfully.");
                            window.location.reload();

                        },
                        error:function(data){
                            $('#loader').hide();
                            $('#listing_screen').show();
                        //    alert("Server Error.");
                        }
                      });
                    }


                });


                function validate(name, bname, add, email, phone, territoryList){
                  var mailformat = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;
                    if(name==""){
                      alert("name can not be empty");
                      return false;
                    }else if(bname==""){
                      alert("Bussiness name can not be empty");
                      return false;
                    }else if(add==""){
                      alert("Address can not be empty");
                      return false;
                    }else if(!(email.match(mailformat))) {
                      alert("You have entered an invalid email address!");
                      return false;
                    } else if(territoryList.length<=0){
                      alert("Please select atleast one territory");
                      return false;
                    }else{
                      return true;
                    }


                }


            </script>




        </html>
